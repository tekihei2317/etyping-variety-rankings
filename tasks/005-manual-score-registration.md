# ユーザーによるスコアの登録

スケジュール処理でランキングを更新するは週一程度にする予定なので、その前にユーザーがスコアを登録できる機能を実装します。

仕様としては、ユーザーが種目とスコアを入力し、そのデータが存在するかどうかをe-typingのランキングサイトで確認し、あれば登録します。

## タスク一覧

- [x] スコアが存在するかどうかを判定する関数を、データ取得処理を抽象化して書く
- [x] スコアを登録する画面を作成する
- [x] e-typingからデータを取得する処理を実装する
- [ ] スコアを登録するAPIを作成して、繋ぎこむ

## 完了の条件

- [ ] ユーザーが種目とスコアを入力したとき、e-typingにデータが登録されていれば登録できること
- [ ] ユーザーが種目とスコアを入力したとき、e-typingにデータが登録されていても登録済みであれば登録しないこと
- [ ] ユーザーが種目とスコアを入力したとき、e-typingにデータが登録されていなければ登録できないこと

## メモ

Browser Binding（puppeteerに必要）は`--remote`フラグが必要なので、とりあえず`wrangler dev --remote`で起動したワーカーにリクエストを送って動作確認することにする。

```bash
curl -X POST http://localhost:8787/api/register-score \
  -H "Content-Type: application/json" \
  -d '{
    "categoryId": "life",
    "username": "tsato",
    "score": 476
  }'
```
`wrangler dev --remote`はビルドしてアセットディレクトリが更新されたら、それを検知してアップロードしてくれるみたい。なのでスクレイピングの動作確認しようと思ったらビルドする必要がある。

登録のAPIで実行すること

まず、そのデータがデータベースに存在するかどうかを確認する。既存より小さいスコアを入力した場合もここで止めていい。

データが登録されていないことが分かったら、e-typingのランキングを確認しに行く。そのカテゴリのランキングページにアクセスして、ページの件数を取得する。とりあえずここまで実装しよう。

ページの件数が取得できたら、二分探索して目的のページを探す。そのページと、次のページを確認して、存在するかどうかを判定する。

存在しないことがわかったら、エラーを返す。存在することがわかったら、データベースにデータを登録する。

documentがないっていうからlib: ["DOM"]追加したんだけど大丈夫だったかな？
